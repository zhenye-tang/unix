## Unix 环境高级编程

### 1. Unix 基础知识

#### 1.1 基本概念

1. 所有操作系统都需要向它们运行的程序提供各种服务。通常这些服务包括执行新程序、打开文件、读文件、分配存储区以及获得当前时间等

#### 1.2 Uinx 体系结构

1. 操作系统是一个软件，他控制计算机硬件资源，提供程序运行环境。一般而言，称这种软件为内核，它相对较小，位于环境的中心
2. 内核的接口被称为系统调用（system call）。公用函数库构建在系统调用接口之上，应用软件既可以使用公用库函数，也可使用系统调用。
3. shell 是一种特殊的应用程序，它为运行其他应用程序提供了一个接口
4. 广义上，操作系统包括内核和一些其他软件，这些软件使得计算机能够发挥作用，并给予计算机以独有的特性。这些软件包括系统使用程序、应用软件、shell 以及公用函数

#### 1.3 登录名

1. 登录名

   * 用户在登录 Unix 系统时，先输入登录名，然后输入口令。系统在其口令文件（/etc/passwd）中查看登录名。口令文件存储当前系统中所有用户的信息，每一项由7个以冒号分隔的字段组成，它们是：登录名、加密口令、用户ID、组ID、注释字段、家目录、shell 程序类型

   * ```c
        --------------------------------------------------------------------------------------------------
        /etc/passwd 存储当前系统中所有用户的信息
        
        user:   x   :     123   :    456   :  xxxx     :  /home/user :  /bin/bash
        用户名 密码占位符  用户编号    用户组编号  用户注释信息   用户主目录     shell 类型
        
        root用户编号固定为0
        除了 root 用户外的其他用户，当用户被创建时，会在 /home 目录下为用户创建一个和用户名相同的目录作为这个用户的家目录
            
        root:x:0:0:root:/root:/bin/bash
        tzy:x:1000:1000:tzy,,,:/home/tzy:/bin/bash
        sshd:x:122:65534::/run/sshd:/usr/sbin/nologin
        ftp:x:123:127:ftp daemon,,,:/srv/ftp:/usr/sbin/nologin
        --------------------------------------------------------------------------------------------------
     ```

2. shell

   * 是一个命令行解释器，他读取用户输入，然后执行命令。用户通常用终端，有时通过文件（shell 脚本）向shell进行输入

#### 1.4 文件和目录

1. 文件系统

   * Unix 文件系统是目录和文件组成的一种层次结构，目录的起点称为根（root）,其名字是一个字符/。目录（directory）是一个包含许多**目录项**的文件，在逻辑上，可以认为每个**目录项**包含一个文件名，同时还包含说名该文件属性的信息。文件属性指文件类型、大小、文件所有者、文件权限（其他用户能否访问该文件）以及文件最后的修改时间等。stat 和 fstat 函数返回所有文件属性的信息结构
2. 文件名

   * 目录中的各个名字称为文件名（filename）。不能出现在文件名中的字符只有斜线（/）和空操作符（null）两个。斜线用来分隔构成路径名的各文件名，空操作符则用来终止一个路径名。
   * 创建新目录时会自动创建两个文件名：. 和 .. 。点指当前目录，两点指父目录。在最高层的根目录，点与两点相同（自己是祖宗，没父节点）
   
3. 路径名
   * 一个或多个以斜线分隔的文件名序列构成路径名，以斜线开头的路径称为**绝对路径**，否则称为相对路径。相对路径名引用与相对于当前目录的文件。文件系统根的名字 / 是一个特殊的绝对路径名，它不包含文件名。

#### 1.5 输入与输出

1. 文件描述符

   * 是一个非负整数，内核用它标识一个特定进程正在访问的文件。当内核打开一个已有文件或创建一个新文件时，它返回一个文件描述符（总是返回当前最小的一个，文件描述符是一个数组指针）。在读写文件时，文件描述符就代表这个文件。

2. 标准输入、输出、出错

   每当运行一个新程序时，所有的 shell 都为其打开三个文件描述符：标准输入、输出、出错（文件描述符分别为：0、1、2)。如果像简单的命令ls那样没有做什么特殊处理，则这三个文件名描述符都链向终端。大多数shell提供一种方法可以重定向这三个文件描述符，如：ls > 1.txt

3. 系统调用 IO

   函数 open、read、write、lseek 以及 close 提供了不用缓冲的I/O操作。这些函数使用文件描述符

4. 标准 I/O

   存在缓冲机制，是对系统调用 I/O 的封装实现

#### 1.6 程序和进程

1. 程序

   * 程序是存放在磁盘上、处于某个目录中的一个可执行文件。
   * 程序是静态的，是存在于外存中的，电脑关机后仍然存在
   * 程序文件是有格式的，Unix 操作系统的通用程序文件格式是 ELF，程序文件是由源码编译过来的，源码文件很多都是用 C 或者 C++ 写的
   * 使用6个exec函数中的一个由内核将程序读入内存，并使其执行

2. 进程和进程 ID

   * 进程是程序的执行过程
   * 进程是动态的，是存在于内存之中的，是程序的执行过程，电脑关机后就不存在进程了。
   * 进程的启动就是将程序从外存加载刀内存的过程
   * 进程是操作系统分配和管理系统资源的基本单位
   * Unix 系统确保每个进程都有一个唯一的数字标识符，称为进程 ID（Process ID）。是非负整数

3. 进程控制

   三个用于进程控制的主要函数：fork、exec、waitpid。exec 函数由6种变体，经常将他们统称为 exec 函数族

4. 线程与线程ID

   * 通常一个进程只有一个线程，同一时刻只执行一组机器指令。对于某些问题，如果不同部分各使用一个控制线程，那么整个问题解决起来就容易得多。另外，多个控制线程也能充分利用多处理器系统的并行性。
   * 在能跑复杂操作系统的芯片上，可以直接加载运行任意一个可执行程序，一个可执行程序就是一个进程，而可执行程序中又可能存在多线程的相关代码。
   * 而在小芯片（mcu 芯片）上，最多跑个 rtos，rtos 并不能直接加载并运行文件系统中的文件，rtos 这个程序是将 elf 转为 bin 文件烧写到芯片中的，因此这个 bin 文件就是一个进程，这个进程中有多个线程。是一个单进程多线程的程序。
   * 如果 mcu 能够解 elf 文件，并将解析后的机器码交给操作系统，操作系统将机器码加载到内存中，然后将一套寄存器转过去执行，是否能够在 mcu 运行时，去执行另外一个程序呢？
   * 一个进程内的所有线程共享同一地址空间、文件描述符、栈以及进程相关的属性。因为它们能访问同一存储区，所以各线程在访问共享数据时需要采取同步措施避免不一致性
   * 线程也用 ID 标识，但是线程 ID 只在它所属的进程内起作用。一个进程中的线程 ID 在另一个进程中毫无意义。在进程中对多个线程进行操作时，我们用线程ID引用相应的线程
   * 进程由操作系统管理，进程 ID 是当前操作系统中唯一的，使用 ps axf 可查看。而线程由进程管理，线程 ID 在同一进程中是唯一的

#### 1.7 出错处理

1. 

#### 1.8 用户标识

1. 用户 ID

   * 口令文件登陆项中的用户ID(user ID)是个数值，它向系统标识各个不同的用户。用户不能更改其用户ID，通常每个用户有一个唯一的用户 ID

   * 用户ID为0的用户为根或超级榕湖。在口令文件中，通常有一个登陆项，登录名为 root，这种用户的特权为超级用户特权

2. 组 ID

   * 口令文件登录项也包括用户的组ID(group ID)，它是一个数值。组ID也是由系统管理员在指定用户登录名时分配的。一般来说，在口令文件中有多个记录项具有相同的组ID
   * 组被用于减肥若干用户分到不同的项目组或部门中，同一组的各成员之间共享资源

3. 附加组 ID

   * 除了在口令文件中对一个登录名指定一个组ID外，大多数 Unix 系统版本还允许一个用户属于另外的组。允许一个用户属于多至16个另外的组

#### 1.9 信号

1. 信号（singal）
   * 是通知进程已发生某种情况的一种技术。例如，某一进程执行除法操作，除数为0，则将名为 SIGFPE (浮点异常)的信号发送该进程。进程如何处理信号有三种选择
   * 忽略该信号。有些信号标识硬件异常，例如，除0或访问进程地址空间以外的单元等，因为这些异常产生的后果不确定，所以不推荐使用这种处理方式
   * 按系统默认方式处理。对于除0的情况，系统默认终止该进程
   * 提供一个函数，信号发生时则调用该甘薯，这被称为捕捉该信号。使用这种方式，需要编写一个函数，信号发生时按照自己希望的方式去处理
   * 很多情况会产生信号。终端键盘上有两种产生信号的方法，分别称为中断键（interrupt key，通常是 Delete 或者 Ctrl + C）和退出键（quit key，通常是 ctrl + \），它们被用于中断当前运行的进程。另外一种产生信号的方式是调用名为 Kill 的函数。在一个进程中调用此函数就可向另外一个进程发送一个信号。当然这样做也有些限制：当向一个进程发信号时，我们必须是该进程的所有者或超级用户

#### 1.10 时间值

​	长期来，Unix 系统一直使用两种不同的时间值：

1. 日历时间。该值是自 1970 年 1月 1日 00:00:00 以来国际标准时间（UTC）所经过的秒数累计值。这些时间值可用于记录文件最近一次的修改时间。系统基本数据类型 time_t 用于保存这种时间值
2. 进程时间。也称为CPU时间，用以度量进程使用的中央处理机的时间。进程时间以时钟滴答计算，历史上曾经取每秒中为50、60、100个滴答

#### 1.11 系统调用和库函数

* 所有的操作系统都提供多种服务的入口点，程序由此向内核请求服务。各种版本的 Unix 实现都提供定义明确、数量有限、可直接进入内核的入口点，这些入口点被称为系统调用
* 系统调用接口在 man 手册的第二部分
* 系统调用与库函数之间的另一个差别是：系统调用通常提供一种最小接口，而库函数通常提供比较复杂的功能。
* 进程控制系统调用（fork、exec、wait）通常由用户应用程序直接调用，但是为了简化某些常见的情况，Unix 系统也提供了一些库函数，例如 system（起子进程） 和 popen。

### 2. 文件IO

#### 2.1 基础概念

* 文件 IO 就是系统调用IO
* 常用函数：open、read、write、lseek 以及 close








